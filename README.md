# Knowledge Portal - ポータブル版

## 🎯 プロジェクト概要

**Knowledge Portal**は、IT人材育成のための包括的な学習管理システムです。このポータブル版は、**Node.jsのインストールが不要**で、職場環境の制限下でも動作する完全なソリューションです。

### 🌟 主な特徴
- **ポータブル性**: USBメモリで持ち運び可能
- **インストール不要**: 管理者権限不要で即座に利用可能
- **Windows統合**: SID認証によるシームレスなログイン
- **リアルタイム通知**: 学習指示の即座な通知
- **データ永続化**: Z-driveベースの確実なデータ保存

---

## 🏗️ 技術アーキテクチャ

### 技術スタック
- **フロントエンド**: Next.js 15.5.4 + React 19.1.1
- **スタイリング**: Tailwind CSS 3.4.0
- **言語**: TypeScript
- **ランタイム**: Node.js v22.18.0（ポータブル版）
- **データベース**: ファイルベース（CSV/JSON）

### アーキテクチャ設計

#### システム全体図
```
┌─────────────────────────────────────────────────────────────────┐
│                    Z:\knowledge_portal\                        │
│                    (ネットワークドライブ)                        │
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   shared/       │  │   users/        │  │   notifications/│ │
│  │   ├─ categories/│  │   ├─ SID-A/     │  │   ├─ SID-A/     │ │
│  │   ├─ materials/ │  │   ├─ SID-B/     │  │   ├─ SID-B/     │ │
│  │   └─ skills/    │  │   ├─ SID-C/     │  │   ├─ SID-C/     │ │
│  │                 │  │   ├─ ...        │  │   ├─ ...        │ │
│  │                 │  │   └─ SID-J/     │  │   └─ SID-J/     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ ネットワーク接続
                                │
┌─────────────────────────────────────────────────────────────────┐
│                Next.js サーバー (localhost:3008)                │
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   data/         │  │   .next/        │  │   node_modules/ │ │
│  │   ├─ users/     │  │   ├─ cache/     │  │   ├─ next/      │ │
│  │   ├─ categories/│  │   ├─ static/    │  │   ├─ react/     │ │
│  │   └─ materials/ │  │   └─ server/    │  │   └─ ...        │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ HTTP接続
                                │
┌─────────────────────────────────────────────────────────────────┐
│                    ユーザー端末群                              │
│                                                                 │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
│  │ ユーザーA│  │ ユーザーB│  │ ユーザーC│  │ ユーザーD│  │ ユーザーE│ │
│  │ SID-A   │  │ SID-B   │  │ SID-C   │  │ SID-D   │  │ SID-E   │ │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘ │
│                                                                 │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
│  │ ユーザーF│  │ ユーザーG│  │ ユーザーH│  │ ユーザーI│  │ ユーザーJ│ │
│  │ SID-F   │  │ SID-G   │  │ SID-H   │  │ SID-I   │  │ SID-J   │ │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

#### 10人同時接続時の動作フロー
```
1. ユーザーAがログイン
   ┌─────────┐    HTTP POST    ┌─────────────────┐    Z-drive読み込み    ┌─────────────────┐
   │ ユーザーA│ ──────────────→ │ Next.js サーバー │ ──────────────────→ │ Z:\knowledge_   │
   │ SID-A   │                 │ localhost:3008  │                     │ portal\users\   │
   └─────────┘                 └─────────────────┘                     │ SID-A\profile.  │
                                                                        │ json            │
                                                                        └─────────────────┘

2. ユーザーBがログイン（同時）
   ┌─────────┐    HTTP POST    ┌─────────────────┐    Z-drive読み込み    ┌─────────────────┐
   │ ユーザーB│ ──────────────→ │ Next.js サーバー │ ──────────────────→ │ Z:\knowledge_   │
   │ SID-B   │                 │ localhost:3008  │                     │ portal\users\   │
   └─────────┘                 └─────────────────┘                     │ SID-B\profile.  │
                                                                        │ json            │
                                                                        └─────────────────┘

3. 通知ポーリング（30秒間隔）
   ┌─────────┐    HTTP GET     ┌─────────────────┐    Z-drive読み込み    ┌─────────────────┐
   │ ユーザーA│ ──────────────→ │ Next.js サーバー │ ──────────────────→ │ Z:\knowledge_   │
   │ SID-A   │                 │ /api/notifications│                    │ portal\users\   │
   └─────────┘                 └─────────────────┘                     │ SID-A\notifications\│
                                                                        │ notifications.json│
                                                                        └─────────────────┘
```

#### パフォーマンス予測（10人同時接続時）
```
メモリ使用量:
- Next.js サーバー: ~200MB
- ページキャッシュ: ~100MB
- 合計: ~300MB（安全圏内）

API レスポンス時間:
- 認証API: ~500-800ms（ファイルI/O待機）
- 通知API: ~100-150ms（Z-drive待機）
- コンテンツAPI: ~300-500ms（CSV読み込み待機）

通知ポーリング負荷:
- 30秒間隔 × 10ユーザー = 20回/分のAPI呼び出し
- 1時間 = 1,200回のAPI呼び出し
- 1日 = 28,800回のAPI呼び出し
```

---

## 📁 ディレクトリ構造

```
nextjs-app-portable/
├── 📄 start.bat                    # 起動スクリプト
├── 📄 server.js                    # カスタムサーバー
├── 📄 package.json                 # プロジェクト設定
├── 📄 .cursorrules                 # Cursor開発ルール
├── 📄 README.md                    # このファイル
├── 📄 DRIVE_SETUP.md               # ネットワークドライブ設定ガイド
├── 📁 portable-node/               # ポータブルNode.js環境
│   ├── 📄 node.exe                # Node.js実行ファイル
│   ├── 📄 npm.cmd                 # npmコマンド
│   └── 📁 node_modules/           # Node.js依存関係
├── 📁 src/                        # ソースコード
│   ├── 📁 app/                    # Next.js App Router
│   │   ├── 📁 api/                # API Routes
│   │   │   ├── 📁 auth/           # 認証API
│   │   │   ├── 📁 assignments/    # 学習指示API
│   │   │   ├── 📁 notifications/  # 通知API
│   │   │   ├── 📁 content/        # コンテンツAPI
│   │   │   ├── 📁 progress/       # 進捗API
│   │   │   └── 📁 admin/          # 管理API
│   │   ├── 📁 assignments/        # 学習指示ページ
│   │   ├── 📁 learning-tasks/    # 学習課題ページ
│   │   ├── 📁 leaderboard/       # リーダーボードページ
│   │   ├── 📁 admin/              # 管理ページ
│   │   ├── 📁 profile/            # プロフィールページ
│   │   ├── 📄 layout.tsx          # ルートレイアウト
│   │   ├── 📄 page.tsx            # ダッシュボード
│   │   └── 📄 globals.css         # グローバルスタイル
│   ├── 📁 components/             # React コンポーネント
│   │   ├── 📄 Header.tsx          # ヘッダーコンポーネント
│   │   ├── 📄 NotificationCenter.tsx # 通知センター
│   │   ├── 📄 ContentModal.tsx    # コンテンツモーダル
│   │   ├── 📄 ThemeToggle.tsx     # テーマ切り替え
│   │   ├── 📄 ProgressChart.tsx   # 進捗チャート
│   │   └── 📁 ui/                 # UIコンポーネント
│   ├── 📁 contexts/               # React Context
│   │   ├── 📄 AuthContext.tsx     # 認証状態管理
│   │   ├── 📄 NotificationContext.tsx # 通知状態管理
│   │   └── 📄 ThemeContext.tsx    # テーマ状態管理
│   ├── 📁 hooks/                  # カスタムフック
│   ├── 📁 lib/                    # ユーティリティ
│   │   ├── 📄 data.ts             # データアクセス層
│   │   ├── 📄 auth.ts             # 認証ロジック
│   │   ├── 📄 api.ts              # API クライアント
│   │   └── 📄 errorHandler.ts     # エラーハンドラー
│   ├── 📁 config/                 # 設定ファイル
│   │   └── 📄 drive.ts            # ネットワークドライブ設定
│   └── 📄 middleware.ts           # Next.js ミドルウェア
├── 📁 data/                       # ローカルデータ（同期用）
│   ├── 📄 users.csv               # ユーザー一覧
│   ├── 📄 materials.csv           # 学習コンテンツ
│   ├── 📄 categories.csv          # カテゴリ
│   └── 📄 departments.csv         # 部署
└── 📁 .next/                      # ビルド済みファイル（自動生成）
```

---

## 🚀 クイックスタート

### 1. 起動方法
```bash
# 方法1: ダブルクリック
start.bat

# 方法2: コマンドライン
cd nextjs-app-portable
.\start.bat
```

### 2. アクセス
- **URL**: `http://localhost:3000`
- **自動起動**: ブラウザが自動で開きます
- **認証**: Windows SIDによる自動ログイン

### 3. 職場環境での設定
**ネットワークドライブが異なる場合**:
```typescript
// src/config/drive.ts を編集
const DEFAULT_DRIVE_PATH = 'Z:\\knowledge_portal';
// ↓ 職場環境に応じて変更
const DEFAULT_DRIVE_PATH = 'G:\\マイドライブ\\knowledge_portal';
```

**詳細は `DRIVE_SETUP.md` を参照**

### 4. 終了方法
- **コマンドプロンプト**: `Ctrl+C`
- **ウィンドウ**: コマンドプロンプトウィンドウを閉じる

---

## 🔧 詳細機能

### 1. 認証システム
- **SID認証**: WindowsドメインのSIDを使用した自動認証
- **セッション管理**: Cookie-based（`knowledge_portal_session`）
- **権限管理**: 3段階（user/instructor/admin）
- **自動ログイン**: 初回アクセス時に自動認証

### 2. 学習管理
- **ダッシュボード**: 学習進捗の可視化
- **コンテンツ管理**: 動画、記事、クイズの管理
- **進捗追跡**: 個人・部署別の学習進捗
- **コンテンツモーダル**: 詳細表示・進捗更新

### 3. 学習指示機能
- **指示作成**: instructor/adminが学習指示を作成
- **進捗管理**: 開始/完了/期限管理
- **通知連動**: 指示作成時に自動通知
- **期限管理**: 期限切れの自動検出

### 4. 通知システム
- **リアルタイム通知**: 学習指示の受信通知
- **永続化**: Z-driveへの確実な保存
- **UI操作**: 既読/削除/一括操作
- **デバッグ情報**: 通知状態の表示

### 5. リーダーボード
- **ランキング表示**: 学習成果の可視化
- **部署別表示**: instructorは自分の部署、adminは全部署
- **スキルマップ**: 個人・部署別のスキル分析

### 6. テーマシステム
- **ライト/ダーク/システム**: 3つのテーマ
- **自動切り替え**: システム設定に連動
- **永続化**: ユーザー設定の保存

---

## 📊 データ管理

### データソース
- **Z-drive優先**: `Z:\knowledge_portal\`を最優先データソース
- **ローカル同期**: `nextjs-app-portable/data/`にフォールバック
- **ファイル形式**: CSV（グローバル）、JSON（ユーザー別）
- **文字エンコーディング**: UTF-8
- **設定一元化**: `src/config/drive.ts`でドライブパスを管理

### データ構造
```
Z:\knowledge_portal\
├── shared/                        # 共有データ
│   ├── users.csv                  # ユーザー一覧
│   ├── categories.csv             # カテゴリ一覧
│   ├── materials.csv              # 学習コンテンツ一覧
│   └── departments.csv            # 部署一覧
└── users/                         # ユーザー別データ
    └── {SID}/                     # ユーザー別ディレクトリ
        ├── assignments/           # 学習指示データ
        │   └── assignments.json
        ├── notifications/         # 通知データ
        │   └── notifications.json
        └── activities.json        # 学習活動データ
```

---

## 🔌 API仕様

### 認証API
```
GET  /api/auth                     # 認証情報取得
POST /api/auth                     # 認証処理
```

### コンテンツAPI
```
GET  /api/content                  # コンテンツ一覧
GET  /api/content/{id}             # コンテンツ詳細
```

### 進捗API
```
GET  /api/progress/{userId}        # 進捗取得
POST /api/progress/{userId}        # 進捗更新
```

### 学習指示API
```
GET  /api/assignments              # 学習指示一覧
POST /api/assignments              # 学習指示作成
PUT  /api/assignments/{id}         # 学習指示更新
```

### 通知API
```
GET  /api/notifications            # 通知一覧
POST /api/notifications            # 通知作成
PUT  /api/notifications            # 通知更新（既読/削除）
```

### 管理API
```
GET  /api/admin/users              # ユーザー管理
GET  /api/admin/reports            # レポート
```

---

## 🛠️ 開発環境

### 必要な環境
- **OS**: Windows 10/11
- **メモリ**: 4GB以上
- **ディスク容量**: 500MB以上
- **ネットワーク**: Z-driveアクセス可能

### 不要なもの
- ❌ Node.jsインストール
- ❌ npmインストール
- ❌ 管理者権限
- ❌ インターネット接続（起動後）

### 開発用コマンド
```bash
# 開発サーバー起動
npm run dev -- --port 3000

# ビルド
npm run build

# テスト
npm run test

# 型チェック
npm run type-check
```

---

## 🔍 トラブルシューティング

### 1. サーバーが起動しない
**原因**: ポート競合
```bash
# 解決方法
netstat -aon | findstr :3000
taskkill /f /pid {PID}
npm run dev -- --port 3001
```

### 2. 認証エラーが発生する
**原因**: キャッシュ破損
```bash
# 解決方法
Remove-Item -Recurse -Force .next
npm run dev -- --port 3001
```

### 3. データが表示されない
**原因**: Z-driveアクセス失敗
```bash
# 確認方法
# 1. Z-driveがマウントされているか確認
# 2. ネットワーク接続を確認
# 3. ファイル権限を確認
```

### 4. 通知が動作しない
**原因**: 通知ファイルの権限問題
```bash
# 確認方法
# 1. Z:\knowledge_portal\users\{SID}\notifications\ の存在確認
# 2. ファイルの読み書き権限確認
# 3. API ログの確認
```

---

## 📈 パフォーマンス最適化

### 1. データアクセス最適化
- **Z-drive優先**: ネットワークドライブを最優先
- **ローカルフォールバック**: アクセス失敗時の代替
- **同期**: データの一貫性を保つ

### 2. キャッシュ管理
- **Next.jsキャッシュ**: `.next`フォルダの管理
- **ブラウザキャッシュ**: キャッシュバスティング
- **APIキャッシュ**: 適切なキャッシュヘッダー

### 3. メモリ管理
- **React Context**: 適切な状態管理
- **useEffect**: 依存関係の適切な設定
- **メモリリーク**: イベントリスナーの適切な削除

---

## 🔒 セキュリティ

### 1. 認証・認可
- **SID認証**: Windowsドメインのセキュリティ
- **権限管理**: 適切なアクセス制御
- **セッション管理**: セキュアなCookie設定

### 2. データ保護
- **分散データ**: ユーザーごとのデータ分離
- **ファイル同期**: 安全なネットワーク同期
- **ログ管理**: アクセスログの記録

### 3. 入力検証
- **API入力**: 適切なバリデーション
- **XSS防止**: 入力サニタイゼーション
- **CSRF防止**: 適切なトークン管理

---

## 📝 開発ルール

### 1. コミットメッセージ
- **日本語で記述**: すべてのコミットメッセージは日本語
- **詳細な説明**: 変更内容を具体的に記述
- **機能別分類**: 機能追加/バグ修正/リファクタリング

**例**:
```
通知機能の完全実装とUI/UX改善

- 通知システムの永続化実装（Z-driveベース）
- 通知ボタンの動作改善：
  * 「確認する」ボタン：既読にするだけで通知は残す
  * 「×」ボタン：即座に削除
  * 「すべて既読」ボタン：サーバー側に反映
  * 「クリア」ボタン：サーバー側から削除
- 認証完了後の通知読み込み実装
- キャッシュバスティングによる即座反映
- デバッグ情報表示機能追加
- 通知作成時の自動通知送信機能
- 学習指示作成時の通知自動生成
```

### 2. サーバー起動ルール
- **ポート+1**: 修正の度にポート番号を+1
- **キャッシュクリア**: 必ず`.next`フォルダを削除
- **プロセス管理**: 既存プロセスの適切な終了

---

## 🎯 ユーザーの期待値

### 1. 機能面
- **完全な動作**: すべての機能が正常に動作
- **リアルタイム更新**: 変更が即座に反映
- **データ永続化**: Z-driveへの確実な保存
- **エラー処理**: 堅牢なエラーハンドリング

### 2. ユーザビリティ
- **直感的なUI**: 分かりやすい操作
- **レスポンシブ**: モバイル対応
- **テーマ対応**: ライト/ダーク切り替え
- **通知**: 適切なタイミングでの通知

### 3. パフォーマンス
- **高速レスポンス**: 素早い画面遷移
- **安定性**: クラッシュしない
- **データ整合性**: データの不整合なし

---

## 📚 参考資料

### 技術ドキュメント
- **Next.js**: https://nextjs.org/docs
- **React**: https://react.dev/
- **TypeScript**: https://www.typescriptlang.org/docs/
- **Tailwind CSS**: https://tailwindcss.com/docs

### プロジェクト内ドキュメント
- **.cursorrules**: 開発ルール
- **DRIVE_SETUP.md**: ネットワークドライブ設定ガイド
- **src/config/drive.ts**: ドライブ設定（1箇所変更で済む）
- **src/lib/data.ts**: データアクセス層
- **src/contexts/**: 状態管理
- **src/app/api/**: API仕様

---

## 🎉 まとめ

Knowledge Portal ポータブル版は、職場環境の制限下でも利用できる完全なソリューションです。

**主な利点**:
- **ポータブル性**: USBメモリで持ち運び可能
- **インストール不要**: 管理者権限不要
- **Windows統合**: SID認証によるシームレスなログイン
- **データ永続化**: Z-driveベースの確実なデータ保存
- **リアルタイム通知**: 学習指示の即座な通知
- **設定一元化**: 1箇所の変更で職場環境に対応

このシステムにより、IT人材育成の効率化と学習進捗の可視化を実現できます。

---

**作成日**: 2025-10-03  
**更新日**: 2025-10-04  
**バージョン**: v2.1.0  
**対象**: 開発者・ユーザー・メンテナンス担当者  
**重要度**: 高（参考資料）
