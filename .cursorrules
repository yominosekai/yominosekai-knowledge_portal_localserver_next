# Knowledge Portal Rules - AI Optimized

## CRITICAL RULES
1. SERVER: ALWAYS use .\restart-server.ps1 for server restart (auto port increment 4000-4099, PID kill, cache clear)
2. LANGUAGE: All responses in Japanese
3. DATA: Z:\knowledge_portal\ priority, local fallback only
4. NOTIFICATIONS: Z-drive persist, real-time UI, cache busting
5. AUTH: Auto-clear cache, ignore Chrome extension errors, 2s wait + 5 retries

## PROJECT
- Next.js 15.5.4 + React 19.1.1 + TypeScript + Tailwind CSS 3.4.0
- SID auth, Cookie sessions, 3 roles (user/instructor/admin)
- Z-drive primary, local sync, CSV/JSON formats

## API ENDPOINTS
- GET /api/auth, /api/progress/{userId}, /api/content, /api/assignments
- POST /api/assignments, /api/notifications
- GET /api/notifications

## KEY FEATURES
- Auth: SID-based Windows domain auth
- Learning: Dashboard, content management, progress tracking
- Assignments: Create/manage learning tasks, auto-notifications
- Notifications: Real-time, Z-drive persist, 60s polling + health check
- Leaderboard: Rankings by department

## SOLVED ISSUES
- Cache: ClientHeader dynamic import (ssr: false)
- Notifications: Cache busting (?t=${Date.now()})
- Assignments: Dynamic content titles in page.tsx
- Session: Direct cookie reading
- Auth errors: Global error handler, Chrome extension filter, auto-reload

## WORKFLOW
- Start: ALWAYS use .\restart-server.ps1 (NO manual restart)
- Features: API route → React component → data.ts function → test → commit
- Bugs: Identify → analyze → fix → test → .\restart-server.ps1

## EMERGENCY
- Server down: ALWAYS use .\restart-server.ps1 (NO manual methods)
- Auth errors: .\restart-server.ps1 + Ctrl+Shift+R + check dev tools
- No data: Check Z-drive access, file contents, API responses, auth state
- Notifications: Check Z-drive files, API logs, NotificationContext, cache

## KEY FILES
- src/lib/data.ts: Data access layer
- src/contexts/AuthContext.tsx: Auth state with retry
- src/contexts/NotificationContext.tsx: Notification state
- src/middleware.ts: Auth middleware
- src/app/layout.tsx: Global error handler
- restart-server.ps1: Auto restart script

## SUCCESS FACTORS
- ALWAYS use .\restart-server.ps1 for server restart (port 4000-4099 auto increment)
- Japanese responses
- Z-drive priority
- Real-time notifications
- Error handling
- Complete functionality
- Dynamic imports for cache